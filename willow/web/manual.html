<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.2" />
<title>Willow: Experimental Economics with Python</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #dddddd;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > div.content {
  white-space: pre;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}


@media print {
  div#footer-badges { display: none; }
}

div#toc {
  margin-bottom: 2.5em;
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock-content {
  white-space: pre;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){asciidoc.footnotes(); asciidoc.toc(2);}
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  var cont = document.getElementById("content");
  var noteholder = document.getElementById("footnotes");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      // Use [\s\S] in place of . so multi-line matches work.
      // Because JavaScript has no s (dotall) regex flag.
      note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      spans[i].innerHTML =
        "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
        "' title='View footnote' class='footnote'>" + n + "</a>]";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
}

}
/*]]>*/
</script>
</head>
<body>
<div id="header">
<h1>Willow: Experimental Economics with Python</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<h2 id="_about_this_manual">1. About this manual</h2>
<div class="sectionbody">
<div class="paragraph"><p>You are reading the manual for Willow, a Python framework for
experimental economics developed at the Center for the Study of
Neuroeconomics at George Mason University. This manual presumes that
you already have an understanding of experimental economics, of HTML,
and of Python programming.</p></div>
<div class="paragraph"><p>If you are interested in learning about experimental economics, you
could do worse than to have a look at the following textbooks:</p></div>
<div class="ulist"><ul>
<li>
<p>
Daniel Friedman, <em>Experimental Methods: A Primer for Economists</em>
</p>
</li>
<li>
<p>
John Kagel and Alvin Roth, <em>The Handbook of Experimental Economics</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In order to get started with Python if you already know how to program
in some other language, you can try</p></div>
<div class="ulist"><ul>
<li>
<p>
Mark Pilgrim, <em>Dive into Python</em>  <a href="http://diveintopython.org">http://diveintopython.org</a>
</p>
</li>
<li>
<p>
Guido van Rossum et al., <em>The Python Tutorial</em>
  <a href="http://docs.python.org/tutorial/">http://docs.python.org/tutorial/</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you want to learn both the craft of computer programming and the
Python programming language at the same time, you are in luck, since
Python is an excellent first language. Some free resources include:</p></div>
<div class="ulist"><ul>
<li>
<p>
Jeffrey Elkner, Allen B. Downey, and Chris Meyers, <em>How to Think
  Like a Computer Scientist</em> <a href="http://openbookproject.net/thinkCSpy/">http://openbookproject.net/thinkCSpy/</a>
</p>
</li>
<li>
<p>
Swaroop C. H., <em>A Byte of Python</em>
  <a href="http://www.swaroopch.com/notes/Python">http://www.swaroopch.com/notes/Python</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Also, in order to use Willow, you need to have basic knowledge of HTML
and CSS, the languages used to build web pages. For this I strongly
recommend</p></div>
<div class="ulist"><ul>
<li>
<p>
Kennedy and Musciano, <em>HTML &amp; XHTML, The Definitive Guide</em>,
   O&#8217;Reilly.
</p>
</li>
</ul></div>
<div class="paragraph"><p>O&#8217;Reilly books are available full-text through an online service
called Safari, which many universities subscribe to. In particular, if
you are at GMU, you can get Safari at
<a href="http://proquest.safaribooksonline.com.mutex.gmu.edu/?uicode=viva">http://proquest.safaribooksonline.com.mutex.gmu.edu/?uicode=viva</a> and
you can this book at
<a href="http://proquest.safaribooksonline.com.mutex.gmu.edu/0596527322">http://proquest.safaribooksonline.com.mutex.gmu.edu/0596527322</a> . If
you are at some other institution, try your library web site listing
of online databases.</p></div>
</div>
<h2 id="_why_willow">2. Why Willow?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Willow is a tool for making the kinds of computer user interfaces
typically used in experimental economics. Without Willow, you might
design such an interface from scratch, or by modifying earlier
from-scratch software written for similar experiments. Using Willow,
you can do the same thing, but faster and better.</p></div>
<div class="paragraph"><p>Willow sets out to accomplish this goal not by providing canned
routines for commonly performed experiments. After all, it is
precisely because our experiments are different from what has gone
before that we bother with them. Rather, Willow is a generic toolkit
that makes a lot of the things we do in experimental economics easy.</p></div>
<div class="paragraph"><p>To use a Willow program, you need only install your program on a
single "monitor" computer. The computers used by your research
subjects will simply run a web browser, which connects to a web server
that runs on the monitor computer. The user interface for the subjects
will be displayed inside the browser window.</p></div>
<div class="paragraph"><p>Willow is a versatile program, and you can use it for many different
interfaces; but you might just be curious what a Willow interface can
look like. Here are some examples taken from the first study that used
Willow at the Center for the Study of Neuroeconomics and the
Interdisciplinary Center for Economic Science at George Mason
University.</p></div>
<div class="imageblock">
<div class="content">
<img src="screen1.png" alt="screen1.png" />
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="screen2.png" alt="screen2.png" />
</div>
</div>
</div>
<h2 id="_reading_this_manual">3. Reading this manual</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this manual, I will use <tt>fixed-width font</tt> to indicate anything
that is literally part of some HTML, CSS or Python code. For longer
snippets of code, I will use boxes, like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> random
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> random<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">random</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>Note that there are colors in these boxes, which are merely a
typesetting convention to make it easier to read the code. Similarly,
you may find that many of the better programmer&#8217;s text editors will
color your code in a similar (but not identical) way. Again, the
colors are not part of the code, and they are not actually stored in
your code files, as you can easily verify by opening them up in a less
fancy text editor.</p></div>
</div>
<h2 id="_preliminary_1_html">4. Preliminary 1: HTML</h2>
<div class="sectionbody">
<div class="paragraph"><p>Willow relies on HTML, the hypertext markup language, for the purpose
of constructing a user interface. A complete description of HTML is
outside the scope of this manual, but I&#8217;ll give a brief introduction.</p></div>
<div class="paragraph"><p>An HTML document is a text file with some special markup sequences. To
practice with HTML, you can construct HTML documents with a text
editor, and load them in a web browser.</p></div>
<div class="paragraph"><p>Consider this example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>This is a paragraph, with a <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>bold<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span> bit in it, and a <span style="font-weight: bold"><span style="color: #0000FF">&lt;br&gt;</span></span>line
break and a <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://google.com"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>link<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;ol&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>This is         the first item of an ordered list.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>This is the second        item of an ordered list.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ol&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>This is the first item of an unordered list. <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>This is the second item of an unordered list.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>This is a div. It has a <span style="font-weight: bold"><span style="color: #0000FF">&lt;span&gt;</span></span>span<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span> in it.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>This is a div. It has another <span style="font-weight: bold"><span style="color: #0000FF">&lt;span&gt;</span></span>span<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span> in it.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>If we type this into a file called <tt>example.html</tt> and load that file in
a web browser, this is what we see:</p></div>
<div class="imageblock">
<div class="content">
<img src="html_1.png" alt="html_1.png" />
</div>
</div>
<div class="paragraph"><p>Even though this is a simple example, it already illustrates some of
the most important points about HTML:</p></div>
<div class="ulist"><ul>
<li>
<p>
HTML is made up of <em>elements</em>, which are delimited by <em>tags</em>. For
  instance, the above example starts with a <tt>p</tt> element, the start of
  which is marked with an opening tag <tt>&lt;p&gt;</tt>, and the end of which is
  marked with a closing tag <tt>&lt;/p&gt;</tt>.
</p>
</li>
<li>
<p>
Elements can have <em>contents</em>. For example, the <tt>b</tt> element in the
  above example contains the text <tt>bold</tt>.
</p>
</li>
<li>
<p>
Some elements, such as <tt>br</tt>, do not have contents, and those do not
  need a closing tag. (Sometimes, you will see these written like <tt>&lt;br
  /&gt;</tt>; this is an XML thing, which you can read about elsewhere.)
</p>
</li>
<li>
<p>
Elements also can have <em>attributes</em>. In the above example, the <tt>a</tt>
  element has an <tt>href</tt> <em>attribute</em>, with <em>value</em> <tt>http://google.com</tt>.
</p>
</li>
<li>
<p>
In HTML, any sequence of newline characters and/or blank characters
  is always treated as a single blank. Extra blanks, or newlines, in
  the HTML source have no effect. If you do want a line break, you can
  use the the HTML element <tt>&lt;br&gt;</tt>.
</p>
</li>
<li>
<p>
Most HTML elements have standard meanings for the browser. The <tt>b</tt>
  element is rendered by typesetting its contents in bold, the <tt>a</tt>
  element describes a link, etc. Strictly speaking, many of these
  meanings are not part of the HTML standard, but in practice, they
  are pretty consistent across browsers. There are two exceptions to
  the rule that each HTML element has a standard meaning: <tt>div</tt> and
  <tt>span</tt>. These have no inherent meaning, and only become useful when
  we start using things like CSS. The difference between <tt>div</tt> and
  <tt>span</tt> is that a <tt>div</tt> is typeset above/below whatever comes
  before/after it, while a <tt>span</tt> is typeset in-line.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Next, we will see a list of common HTML elements.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>&lt;p&gt;&#8230;&lt;/p&gt;</tt>
</dt>
<dd>
<p>
A paragraph.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;ul&gt;&#8230;&lt;/ul&gt;</tt>
</dt>
<dd>
<p>
An unordered (bulleted) list.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;ol&gt;&#8230;&lt;/ol&gt;</tt>
</dt>
<dd>
<p>
An ordered (numbered) list.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;li&gt;&#8230;&lt;/li&gt;</tt>
</dt>
<dd>
<p>
An item for a list.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;div&gt;&#8230;&lt;/div&gt;</tt>
</dt>
<dd>
<p>
A generic chunk of text displayed vertically.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;input&gt;</tt>
</dt>
<dd>
<p>
An input widget
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;b&gt;&#8230;&lt;/b&gt;</tt>
</dt>
<dd>
<p>
A piece of text in bold
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;i&gt;&#8230;&lt;/i&gt;</tt>
</dt>
<dd>
<p>
A piece of text in italics
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;span&gt;&#8230;&lt;/span&gt;</tt>
</dt>
<dd>
<p>
A generic chunk of text displayed in-line.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;a&gt;&#8230;&lt;/a&gt;</tt>
</dt>
<dd>
<p>
A link
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;br&gt;</tt>
</dt>
<dd>
<p>
A line break
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;hr&gt;</tt>
</dt>
<dd>
<p>
A horizontal line
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;table&gt;</tt>
</dt>
<dd>
<p>
A table
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;tr&gt;</tt>
</dt>
<dd>
<p>
A table row
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;td&gt;</tt>
</dt>
<dd>
<p>
A table element
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The last three of these fit together like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;&lt;td&gt;</span></span>Column 1, Row 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;&lt;td&gt;</span></span>Column 2, Row 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;&lt;/tr&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;&lt;td&gt;</span></span>Column 1, Row 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;&lt;td&gt;</span></span>Column 2, Row 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;&lt;/tr&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Some of the more common HTML attributes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>&lt;table border=<em>1</em>&gt;&#8230;&lt;/table&gt;</tt>
</dt>
<dd>
<p>
A table with 1 pixel borders.
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;a href="http://google.com/"&gt;&#8230;&lt;/a&gt;</tt>
</dt>
<dd>
<p>
A link to <tt>http://google.com/</tt>
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;input type=<em>submit</em> value=<em>foo</em>&gt;</tt>
</dt>
<dd>
<p>
A button with label <tt>foo</tt>
</p>
</dd>
<dt class="hdlist1">
<tt>&lt;input type=<em>text</em>&gt;</tt>
</dt>
<dd>
<p>
A text field.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You can learn more about HTML by using either Firefox with the Firebug
plugin, or Google Chrome. Right-click anywhere on the page and select
"Inspect element." This pulls up an HTML explorer system, which looks
like this in Google Chrome (Firefox with the Firebug plugin is
similar):</p></div>
<div class="imageblock">
<div class="content">
<img src="html_2.png" alt="html_2.png" />
</div>
</div>
<div class="paragraph"><p>By playing around with this feature of your browser, you can learn a
lot of about HTML and CSS.</p></div>
</div>
<h2 id="_preliminary_2_css">5. Preliminary 2: CSS</h2>
<div class="sectionbody">
<div class="paragraph"><p>TBA</p></div>
</div>
<h2 id="_preliminary_3_some_python_features">6. Preliminary 3: Some Python features</h2>
<div class="sectionbody">
<div class="paragraph"><p>You should already know Python before reading this manual, but there
are few Python features that you may not be familiar with even if you
do have experience with Python and that will come in useful for
Willow.</p></div>
<div class="paragraph"><div class="title">Format strings</div><p>Python has a convenient way of putting together strings with the <tt>%</tt>
operator.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">"foo %s baz"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span><span style="color: #FF0000">"bar"</span><span style="color: #990000">,)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">"foo %s baz %%"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span><span style="color: #FF0000">"bar"</span><span style="color: #990000">,)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">"foo %s baz %s"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span><span style="color: #FF0000">"bar"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"quux"</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">"foo %s baz %s"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span><span style="color: #FF0000">"bar"</span><span style="color: #990000">,</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">"foo %s baz"</span> <span style="color: #990000">%</span> <span style="color: #FF0000">"bar"</span></tt></pre></div></div>
<div class="paragraph"><p>If you run that through Python, you will see</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>foo bar baz
foo bar baz %
foo bar baz quux
foo bar baz 42
foo bar baz</tt></pre>
</div></div>
<div class="paragraph"><p>As you can see, the <tt>%</tt> operator takes a string, called the "format
string", on its left hand side, and a tuple on its right hand
side. For every "gap" in the format string, indicated by <tt>%s</tt>, the
corresponding element from the tuple will be substituted.</p></div>
<div class="paragraph"><p>In fact, there are a number of gap markers other than <tt>%s</tt> (such as
<tt>%d</tt>, <tt>%r</tt>, etc.) which are described in the "String Formatting
Operations" section in the "Built-in Types" chapter of the Python
library documentation. In practice, <tt>%s</tt> is nearly always what you
want. If you happen to actually want a percent sign in your string,
you should use <tt>%%</tt>.</p></div>
<div class="paragraph"><p>Also, if you only have one value to substitute, you don&#8217;t need to put
it in a one-element tuple; the <tt>%</tt> operator is nice enough to accept
interpret non-tuple values as though they were one-element tuples.</p></div>
</div>
<h2 id="_lesson_0_wherein_we_install_willow">7. Lesson 0: Wherein we install Willow</h2>
<div class="sectionbody">
<div class="paragraph"><p>To install Willow, you extract the zip file to a convenient
location. You will do this anew for each of your Willow projects.  In
addition, you will need to have Python installed. Willow has been
tested using Python 2.6 on Ubuntu GNU/Linux. You should be able to use
it with Python 2.6 on Windows and Mac OSX as well. If you do not have
Python 2.6 on your computer, get it from
<a href="http://www.python.org/download/releases/2.6.3/">http://www.python.org/download/releases/2.6.3/</a> and then come back. If
you are not sure whether you have Python 2.6 on your computer, just
move on to the next section of the manual. If things don&#8217;t work,
you&#8217;ll notice soon enough, and you can go back and install Python. Do
not use Python version 3. It will not work.</p></div>
<div class="paragraph"><p>While programming, you will want to run Willow from within a
programmer&#8217;s text editor (or, if you care for such things, an
Integrated Development Environment). On Mac and Linux, you can use the
IDLE editor that ships with Python. If you are running Windows, the
version of IDLE that ships with Python on that platform is very buggy,
and I recommend strongly that you get a different text editor: in
particular, I recommend SciTE, which is a very simple drop-in
replacement for IDLE. On Mac or Linux, you can get away with just
using IDLE, although you may find that SciTE is a little more
polished. Either way, SciTE can be had from
<a href="http://www.scintilla.org/SciTE.html">http://www.scintilla.org/SciTE.html</a> .</p></div>
</div>
<h2 id="_lesson_1_wherein_we_meet_willow">8. Lesson 1: Wherein we meet Willow</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the Willow folder, you will find a file named <tt>lesson.01</tt>. You need
to run this file: double click on it, or run the command <tt>python
lesson01.py</tt> from the command line. Once the <tt>lesson01.py</tt> program is
running, fire up a web browser and point it to
<tt>http://localhost:8000/</tt>. You should see a page that looks like so:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson01_1.png" alt="lesson01_1.png" />
</div>
</div>
<div class="paragraph"><p>Now pull up the <tt>lesson01.py</tt> file in IDLE or SciTE.</p></div>
<div class="paragraph"><p>In IDLE, this looks like so:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson01_2.png" alt="lesson01_2.png" />
</div>
</div>
<div class="paragraph"><p>In Scite, it looks like:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson01_3.png" alt="lesson01_3.png" />
</div>
</div>
<div class="paragraph"><p>See here the code of a very simple but working Willow program. You can
run it using the <tt>Run &gt; Run Module</tt> menu option in IDLE or the <tt>Tools
&gt; Go</tt> menu in SciTE, or by pressing <tt>F5</tt> (that shortcut key is the
same in both SciTE and IDLE).</p></div>
<div class="paragraph"><p>Again, you now need to point a web browser to <tt>http://localhost:8000</tt>.</p></div>
<div class="paragraph"><p>If you see an error message like "address already in use," you are
probably trying to run two instances of Willow simultaneously. You
should stop the first one first (just close the window).</p></div>
<div class="paragraph"><p>Now, let us look at the above code. Most of it is boilerplate, but the
good news is that this is all the boilerplate you need. The first line
imports the willow library. It assumes that <tt>willow.py</tt> is in a
subdirectory <tt>willow</tt> of the directory in which <tt>lesson01.py</tt> is; this is
how things are set up for the sample programs, and if you put your own
programs in the same place, it will just work. The next two lines
define a session function, and the last line instructs Willow to start
the web server, using the session function that has just been defined.</p></div>
<div class="paragraph"><p>Together, these four lines define a web server that you can connect to
from a browser. If the browser is running on the same machine as the
server, you can use <tt>http://localhost:8000</tt> as a URL. If it is running
somewhere else, you must find out the IP address of the server. (If
you don&#8217;t know it, there is a whole chapter further down in the manual
about how to figure it out.) If the IP address is, say,
<tt>123.123.123.123</tt>, then you can reach your Willow server using
<tt>http://123.123.123.123:8000</tt>. The <tt>:8000</tt> part is called the port
number; you can specify a different port number as an extra argument
to <tt>run</tt> (e.g. <tt>run(session, 8001)</tt>) if you insist on a port different
from 8000.</p></div>
<div class="paragraph"><p>Once the web server is running, for each client that connects to it,
the session function will be called once. It will keep running until
it returns. We say that each session function runs in its own "session
thread". This means that several "copies" of the session function are
running simultaneously, one for each client.</p></div>
<div class="paragraph"><p>In this case, we want to simply display the text "Hello world." in the
web browser of every client that connects, so we have a very simple
session function that does nothing but <tt>add("&lt;h1&gt;Hello,
world.&lt;/h1&gt;")</tt>. The <tt>add()</tt> function adds an HTML snippet to the web
page being displayed in the client&#8217;s browser.</p></div>
<div class="paragraph"><p>Try connecting to <tt>localhost:8000</tt> in multiple browser tabs. You&#8217;ll
see that each one shows "Hello, world." This is because the
<tt>session()</tt> function gets called once for each client that connects.</p></div>
</div>
<h2 id="_lesson_2_wherein_all_clients_are_not_equal">9. Lesson 2: Wherein all clients are not equal</h2>
<div class="sectionbody">
<div class="paragraph"><p>In real applications, we usually do not want to do the same for every
client that connects. More likely, we&#8217;ll want one client to show some
sort of experimenter console, one client to show the interface for
subject 1, one client the interface for subject 2, etc.</p></div>
<div class="paragraph"><p>Have a look at <tt>lesson02.py</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello monitor %s"</span> <span style="color: #990000">%</span> me<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello subject %s"</span> <span style="color: #990000">%</span> me<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The <tt>%</tt> operator in Python is very useful for constructing
strings. You can read about it in section 6.6.2, "String Formatting
Operations", of the Python 2.6.4 Standard Library reference manual.</td>
</tr></table>
</div>
<div class="paragraph"><p>As you can see, there is still only one <tt>session()</tt> function, and for
each client that connects, a session thread is started that runs the
<tt>session()</tt> function. Each client runs the exact same function,
but&#8230; the session function takes an argument, which we call <tt>me</tt>, and
for each client, it gets called with a different value for <tt>me</tt>: 0, 1,
2, and so on. If you reload the page a bunch of times, it looks like
this:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson02_1.png" alt="lesson02_1.png" />
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="lesson02_2.png" alt="lesson02_2.png" />
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="lesson02_3.png" alt="lesson02_3.png" />
</div>
</div>
</div>
<h2 id="_lesson_3_wherein_we_produce_output">10. Lesson 3: Wherein we produce output</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this lesson, we will see some of the Willow functions for
manipulating user interface elements. All of these are based on HTML
and CSS, and it is crucial that you acquire a basic understanding of
these languages. An extensive description of HTML and CSS is outside
the scope of this manual.</p></div>
<div class="paragraph"><p>Have a look at <tt>lesson03.py</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;style type='text/css'&gt;.important { font-weight: bold; }&lt;/style&gt;"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;The &lt;span class='important' id='a'&gt;division&lt;/span&gt; of "</span>
<span style="font-style: italic"><span style="color: #9A1900">        "&lt;span class='b'&gt;labor&lt;/span&gt; is limited "</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        "by the extent of the "</span></span>
        <span style="color: #FF0000">"&lt;a href='http://ebay.ocm'&gt;market&lt;/a&gt;."</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">" and subdivision"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#a"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">let</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"labour"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".b"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">poke</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"href"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"http://ebay.com"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"a"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"important"</span><span style="color: #990000">,</span><span style="color: #FF0000">"#a"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"important"</span><span style="color: #990000">,</span><span style="color: #FF0000">".b"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p class='elusive'&gt;Microfoundations.&lt;/p&gt;"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p class='hidden'&gt;Prices.&lt;/p&gt;"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">hide</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".elusive"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".hidden"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>This displays a web page like so:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson03_1.png" alt="lesson03_1.png" />
</div>
</div>
<div class="paragraph"><p>This shows off all of Willow&#8217;s UI manipulation functions. Let&#8217;s go
through it line by line.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>add("&lt;style type='text/css'&gt;.important { font-weight: bold; }&lt;/style&gt;")</tt></pre>
</div></div>
<div class="paragraph"><p>First we add a style sheet to the page. Again, CSS is beyond the scope
of this manual and you should go out and read up on it, but what this
comes down to is that we instruct the browser to typeset in bold all
HTML elements that have class "important" turned on.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>add("&lt;p&gt;The &lt;span class='important' id='a'&gt;division&lt;/span&gt; of "
    "&lt;span class='b'&gt;labor&lt;/span&gt; is limited "
    "by the extent of the "
    "&lt;a href='http://ebay.ocm&gt;market&lt;/a&gt;.")</tt></pre>
</div></div>
<div class="paragraph"><p>Note that in Python string literal juxtaposition adds the string
literals together, which makes for a convenient way of splitting long
strings over several lines.</p></div>
<div class="paragraph"><p>The <tt>&lt;span&gt;</tt> element in HTML has no default meaning, and without any
style sheets or other manipulations, a piece of HTML enclosed in a
<tt>&lt;span&gt;</tt> is exactly identical to the same piece of HTML not so
enclosed. In the above fragment, we have two <tt>&lt;span&gt;</tt> elementss. Note
that because the style sheet instructed the browser to print all
elements of class <tt>important</tt> in bold, the word "division" is printed
in bold; or at least, it would be, if we did not manipulate it
further.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>add(" and subdivision", "#a")</tt></pre>
</div></div>
<div class="paragraph"><p>This shows that you can add text not just to the page as a whole, but
also to particular elements. The optional second argument to <tt>add</tt> is
a CSS selector. The most common CSS selectors are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>p</tt>, which refers to all <tt>&lt;p&gt;</tt> elements;
</p>
</li>
<li>
<p>
<tt>h1</tt>, which refers to all <tt>&lt;h1&gt;</tt> elements;
</p>
</li>
<li>
<p>
etc.;
</p>
</li>
<li>
<p>
<tt>.x</tt>, which refers to all elements with <tt>class=<em>x</em></tt>;
</p>
</li>
<li>
<p>
<tt>#a</tt>, which refers to the first element with <tt>id=<em>a</em></tt>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Note that some selectors can refer to more than one element, and in
that case, your HTML snippet gets added to all matching elements.</p></div>
<div class="paragraph"><p>In this case, what we are asking Willow to do is to find the first
HTML element with <tt>id=<em>a</em></tt> and add the text " and subdivision" to the
end of it it.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>set("labour", ".b")</tt></pre>
</div></div>
<div class="paragraph"><p>The <tt>set()</tt> function is just like the <tt>add()</tt> function except that
instead of adding HTML to the end of some element, it replaces the
entire contents of the element. In particular, <tt>set("")</tt> clears the
entire page!</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>poke("href", "http://ebay.com", "a")</tt></pre>
</div></div>
<div class="paragraph"><p>So far, we have seen the functions <tt>add</tt> and <tt>set</tt> that manipulate the
contents of HTML elements. But HTML elements have attributes as well
as contents. For instance, if you write <tt>&lt;a href="foo"&gt;&#8230;&lt;/a&gt;</tt>, you
have created an <tt>&lt;a&gt;</tt> element with contents "&#8230;" and with an <tt>href</tt>
attribute with value <tt>foo</tt>. The <tt>poke()</tt> function serves to
manipulate attributes. In this case, we set the <tt>href</tt> attribute of
<strong>every single <tt>&lt;a&gt;</tt> element on the page</strong> to be <tt>http://ebay.com</tt>.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>pop("important","#a")
push("important",".b")</tt></pre>
</div></div>
<div class="paragraph"><p>In HTML, a single element can have more than one class. You can write
that as <tt>&lt;p class=<em>class1 class2</em>&gt;&#8230;&lt;/p&gt;</tt>. The <tt>pop()</tt> and <tt>push()</tt>
functions are there to remove a class from an element and to add a
class to an element, respectively, without changing any other classes
that the element might have.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>add("&lt;p class='elusive'&gt;Microfoundations.&lt;/p&gt;")
add("&lt;p class='hidden'&gt;Prices.&lt;/p&gt;")
hide(".elusive")
show(".hidden")</tt></pre>
</div></div>
<div class="paragraph"><p>The <tt>hide()</tt> and <tt>show()</tt> functions do just that: hide and show
elements. Willow is set up so that any element with class <tt>hidden</tt> set
is hidden by default and only shows up when you call <tt>show()</tt> on it.</p></div>
<div class="paragraph"><p>So far, we have seen the Willow UI primitives: <tt>add</tt>, <tt>set</tt>, <tt>poke</tt>,
<tt>push</tt>, <tt>pop</tt>, <tt>hide</tt>, and <tt>show</tt>. In combination with HTML and CSS,
these primitives make a very powerful UI language.</p></div>
</div>
<h2 id="_lesson_4_wherein_we_chatter">11. Lesson 4: Wherein we chatter</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now that we have seen how to produce output on the client screens, you
may be wondering how we can read input. But before we get to that, we
will first discuss another important feature of Willow: its
communication system.</p></div>
<div class="paragraph"><p>Consider <tt>lesson04.py</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Monitor&lt;/h1&gt;"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
      msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HELLO"</span><span style="color: #990000">})</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;Client %s logged in"</span> <span style="color: #990000">%</span> msg<span style="color: #990000">[</span><span style="color: #FF0000">"number"</span><span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>me<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HELLO"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"number"</span><span style="color: #990000">:</span> me<span style="color: #990000">})</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>In this short program, we can see a typical use case for the important
Willow functions <tt>put()</tt> and <tt>take()</tt>. The first client, for which
<tt>me==0</tt>, acts as a control panel that displays information about other
clients coming online. In order to convey that information, each
client other than the first puts a dictionary <tt>{"tag":"HELLO",
"number":me}</tt> on the Board. The first client retrieves these
dictionaries and uses them to display information about logins.</p></div>
<div class="paragraph"><p>After the monitor client and 3 other clients have connected, the
monitor client display would look like this:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson04_1.png" alt="lesson04_1.png" />
</div>
</div>
<div class="paragraph"><p>To fully understand this, we must understand the Board. The Board is
the one and only data structure that is shared between the various
session threads in Willow.</p></div>
<div class="paragraph"><p>The board contains dictionaries. Dictionaries are sets of key-value
pairs. To put <tt><em>my_dictionary</em></tt> on the board, you call
<tt>put(<em>my_dictionary</em>)</tt>. For instance, to put the empty dictionary <tt>{}</tt>
on the board, you call <tt>put({})</tt>, or to put the very abridged
Dutch-to-English dictionary <tt>{"rood":"red","nederlands":"dutch"}</tt> on
the board, you call <tt>put({"rood":"red","nederlands":"dutch"})</tt>.</p></div>
<div class="paragraph"><p>To retrieve <tt><em>my_dictionary</em></tt> from the board, you call
<tt>take(<em>my_dictionary</em>)</tt>. In practice, though, you typically don&#8217;t know
yet what dictionary you want to retrieve. For that reason, <tt>take()</tt>
allows you to leave out keys you aren&#8217;t sure of. In the extreme case,
you leave out all keys and call <tt>take({})</tt>, which means "please
retrieve any dictionary whatsoever from the board."</p></div>
<div class="paragraph"><p>The <tt>take()</tt> function is blocking. This means that if there is no
matching dictionary on the board, it will sit around waiting until one
appears. This is what happens in the example code: the first thread
(the one with <tt>me==0</tt>) sits around waiting for dictionaries of the
form <tt>{"tag":"HELLO", &#8230;}</tt> to show up on the board. Every time one
such dictionary shows up, the <tt>take()</tt> function returns it, the loop
loops, and the <tt>take()</tt> function is called again, blocking until the
next dictionary shows up.</p></div>
<div class="paragraph"><p>When a dictionary is gotten with <tt>take()</tt>, it is removed from the
board. Therefore, in the above code, you do not need to worry about
looping around retrieving the same dictionary over and over again. If you
want to retrieve a dictionary and leave it available (maybe for some other
thread), you simply put it back on with <tt>put()</tt>.</p></div>
<div class="paragraph"><p>Another important trick in the use of <tt>take()</tt> is that you can specify
more than one pattern. For instance, <tt>take({"tag":"HELLO"},
{"tag":"ERROR"})</tt> blocks until either a dictionary with the key-value
pair <tt>"tag":"HELLO"</tt> or a dictionary with the key-value pair
<tt>"tag":"ERROR"</tt> shows up. <tt>take({"tag":"HELLO"}, {"foo":3})</tt> blocks
until either a dictionary with the key-value pair <tt>"tag":"HELLO"</tt> or a
dictionary with the key-value pair <tt>"foo":3</tt> shows up. And so on.</p></div>
<div class="paragraph"><p>Finally, I will mention <tt>grab()</tt>. It is like <tt>take()</tt>, except that it
does not block. If a matching dictionary is available, it will return that,
but if there is none, it will simply return <tt>None</tt> (unlike <tt>take()</tt>,
which will sit there twiddling its thumbs until a matching dictionary shows
up).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">You could, conceivably, have your own shared data structures
simply by declaring some global variables outside of <tt>session()</tt>, but
I recommend that you don&#8217;t. In order to make sure your data structures
remain consistent, you would have to implement rules to make sure that
no two threads fiddle with them at the same time ("mutual exclusion"),
which can rapidly become extremely complicated. The Board is a variant
on a data structure known as a Tuple Space, which already has mutual
exclusion built into it.</td>
</tr></table>
</div>
</div>
<h2 id="_lesson_5_wherein_we_deal_with_input">12. Lesson 5: Wherein we deal with input</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now that we have seen how to manipulate what appears on a client
screen, we will turn our attention to the issue of input.</p></div>
<div class="paragraph"><p>There are two basic ways of giving input to a Willow client: you can
click things, and you can fill out text fields.</p></div>
<div class="paragraph"><p>The <tt>lesson05.py</tt> code demonstrates both.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;Please enter your name."</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;input id='name' type='text'&gt;"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;input id='go' type='submit'&gt;"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"go"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"client"</span><span style="color: #990000">:</span> me<span style="color: #990000">})</span>
  name <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">peek</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#name"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;Hello, %s."</span> <span style="color: #990000">%</span> name<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This should initially display a screen that looks like so:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson05_1.png" alt="lesson05_1.png" />
</div>
</div>
<div class="paragraph"><p>You can then type something in the text box and click the button
labeled "Submit", and the screen will look like:</p></div>
<div class="imageblock">
<div class="content">
<img src="lesson05_2.png" alt="lesson05_2.png" />
</div>
</div>
<div class="paragraph"><p>What&#8217;s going on here?</p></div>
<div class="paragraph"><p>First of all, HTML elements that look like</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;input type='submit' ...&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>are buttons.</p></div>
<div class="paragraph"><p>In HTML, each <tt>&lt;input&gt;</tt> element that is a button must have two
attributes: <tt>type</tt> must be set to <tt>submit</tt>, to make sure we are
displaying a button and not some other sort of input element, and
<tt>value</tt> must be set to the text that is to be on the button (or, if it
is left out, the text defaults to "Submit", or possibly something else
if your browser is set up for a language other than English).</p></div>
<div class="paragraph"><p>In Willow, your button must additionally have an <tt>id</tt> attribute, which
is how we keep track of which buttons get clicked.</p></div>
<div class="paragraph"><p>When a button gets clicked, a dictionary</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>{"tag": "click", "id":_id_, "client":_n_, "time":_t_}</tt></pre>
</div></div>
<div class="paragraph"><p>is automatically posted onto the board, where</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt><em>n</em></tt> is the number of the client that received the button click;
</p>
</li>
<li>
<p>
<tt><em>id</em></tt> is the <tt>id</tt> of the button;
</p>
</li>
<li>
<p>
<tt><em>t</em></tt> is the time in milliseconds since Jan 1, 1970 0:00 UTC,
   as measured by the client, when the button was clicked
</p>
</li>
</ul></div>
<div class="paragraph"><p>This is why, after we have displayed the button, we can just call
<tt>take({"tag":"click", "id": "go", "client": me})</tt>, which will block
until the button is clicked. Note that if you insist on blocking one
client thread until a button in some <em>other</em> client thread has been
clicked, you can do that, simply by replacing <tt>me</tt> in the above call
to <tt>take()</tt> by some other integer (but it is not recommended).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">If the button is clicked multiple times, multiple dictionaries
will be inserted. This may result in behavior you may not necessarily
intend. If you want to wait for a button to get clicked that may have
been clicked before you started waiting, you will need to clear those
old dictionaries off the board using <tt>grab()</tt>.</td>
</tr></table>
</div>
<div class="paragraph"><p>To show a text field, we use a piece of HTML that looks like</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;input id='name_of_text_field' type='text'&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>and then we call <tt>peek("#<em>name_of_text_field</em>")</tt>, which returns the
current content of that text field. You can also use <tt>peek()</tt> for
checkboxes, radioboxes, <tt>&lt;textarea&gt;</tt> elements, and most other
input-type elements that you can read about in HTML books. In the
above case, we only start looking for what&#8217;s in the field after the
user has pressed the button.</p></div>
</div>
<h2 id="_lesson_6_wherein_we_poke_around_in_other_threads">13. Lesson 6: Wherein we poke around in other threads</h2>
<div class="sectionbody">
<div class="paragraph"><p>Many of the Willow functions, even though by default they operate on
the client display associated with the current session thread, can
also operate on a different client display if you pass the
<tt>client=<em>n</em></tt> optional parameter. This is never necessary, but it may
be more convenient than passing messages through the board to the
other session thread so that it can then manipulate its corresponding
client display.</p></div>
<div class="paragraph"><p>Take for instance the code in lesson 4:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Monitor&lt;/h1&gt;"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
      msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HELLO"</span><span style="color: #990000">})</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;Client %s logged in"</span> <span style="color: #990000">%</span> msg<span style="color: #990000">[</span><span style="color: #FF0000">"number"</span><span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>me<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"HELLO"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"number"</span><span style="color: #990000">:</span> me<span style="color: #990000">})</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>We could rewrite that as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Monitor&lt;/h1&gt;"</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;p&gt;Client %s logged in"</span> <span style="color: #990000">%</span> me<span style="color: #990000">,</span> clients<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>me<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Strictly speaking, the above programs are not entirely
equivalent. If the first session thread executed very, very slowly and
the second client connect immediately after the first, then the
"Client 1 logged in" message could conceivably show up before the
"Monitor" heading when running the second program, but not when
running the first.</td>
</tr></table>
</div>
</div>
<h2 id="_lesson_7_wherein_we_stall_for_time">14. Lesson 7: Wherein we stall for time</h2>
<div class="sectionbody">
<div class="paragraph"><p>Look at this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello, "</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">ping</span></span><span style="color: #990000">():</span>
    <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span><span style="color: #FF0000">"PING"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"client"</span><span style="color: #990000">:</span> me<span style="color: #990000">})</span>
  <span style="font-weight: bold"><span style="color: #000000">background</span></span><span style="color: #990000">(</span>ping<span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span><span style="color: #FF0000">"PING"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"client"</span><span style="color: #990000">:</span> me<span style="color: #990000">})</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"world."</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>It shows "Hello, " on the screen, and 2.3 seconds later, it adds "
world."</p></div>
<div class="paragraph"><p>That&#8217;s all there is to this one. Use the <tt>background(<em>f</em>,<em>dt</em>)</tt>
function to call the function <tt><em>f</em></tt> in the background, after a delay in
seconds of <tt><em>dt</em></tt>. Note that you can also use this (typically with
<tt>dt=0</tt>) for any other background tasks, like dealing with a chatbox
while the main task deals with the rest of the experiment.</p></div>
</div>
<h2 id="_lesson_8_wherein_we_finally_produce_data">15. Lesson 8: Wherein we finally produce data</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello, world."</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"hello"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"world"</span><span style="color: #990000">,</span> me<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>This is how you cause your Willow program to produce a data file.</p></div>
<div class="paragraph"><p>In this case, a data file was produced in the <tt>log</tt> subdirectory
(i.e. folder) called <tt>2010-02-23-22-00-05.csv</tt>. The name is chosen
automatically based on the date and time
(year-month-day-hour-minute-second).</p></div>
<div class="paragraph"><p>The file contains:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>1266985186.84,hello,world,0
1266985187.28,hello,world,1
1266985187.55,hello,world,2
1266985187.76,hello,world,3</tt></pre>
</div></div>
<div class="paragraph"><p>This is a CSV file, which is a simple text-file based spreadsheet
format. It is understood by Excel, OpenOffice, Stata, and other data
analysis software. You can also just open it in a text editor.</p></div>
<div class="paragraph"><p>Each row will automatically get a timestamp added to the front of it,
which is a large integer representing the number of seconds that have
passed since the "Unix epoch" on January 1, 1970, 0:00 UTC. This may
seem like an odd choice of timestamp format, but the advantage of this
type of timestamp is that it makes sense to subtract them!</p></div>
</div>
<h2 id="_lesson_9_wherein_we_program_our_first_experiment">16. Lesson 9: Wherein we program our first experiment</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">lesson09.py</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> willow<span style="color: #990000">.</span>willow <span style="font-weight: bold"><span style="color: #000080">import</span></span> <span style="color: #990000">*</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">session</span></span><span style="color: #990000">(</span>me<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"lesson09_0.html"</span><span style="color: #990000">))</span>
    msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"click"</span><span style="color: #990000">})</span>
    bid <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">[</span><span style="color: #FF0000">"id"</span><span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bid"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"amount"</span><span style="color: #990000">:</span> bid<span style="color: #990000">})</span>
    <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#wait"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>bid<span style="color: #990000">,</span> <span style="color: #FF0000">"#offer"</span><span style="color: #990000">)</span>
    msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"accept"</span><span style="color: #990000">})</span>
    accept <span style="color: #990000">=</span> msg<span style="color: #990000">[</span><span style="color: #FF0000">"accepted"</span><span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> accept<span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#accept,#pay"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #993399">10</span> <span style="color: #990000">-</span> bid<span style="color: #990000">,</span> <span style="color: #FF0000">"#payoff"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#reject,#pay"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#payoff"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"bid"</span><span style="color: #990000">,</span> bid<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"reaction"</span><span style="color: #990000">,</span> accept<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> me <span style="color: #990000">==</span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"lesson09_1.html"</span><span style="color: #990000">))</span>
    msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span><span style="color: #FF0000">"bid"</span><span style="color: #990000">})</span>
    bid <span style="color: #990000">=</span> msg<span style="color: #990000">[</span><span style="color: #FF0000">"amount"</span><span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#offer"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>bid<span style="color: #990000">,</span> <span style="color: #FF0000">"#bid"</span><span style="color: #990000">)</span>
    msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"click"</span><span style="color: #990000">})</span>
    accept <span style="color: #990000">=</span> msg<span style="color: #990000">[</span><span style="color: #FF0000">"id"</span><span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> accept <span style="color: #990000">==</span> <span style="color: #FF0000">"accept"</span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#pay"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>bid<span style="color: #990000">,</span><span style="color: #FF0000">"#payoff"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"accept"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"accepted"</span><span style="color: #990000">:</span> True<span style="color: #990000">})</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#pay"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#payoff"</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"accept"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"accepted"</span><span style="color: #990000">:</span> False<span style="color: #990000">})</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Experiment is full.&lt;/h1&gt;"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">lesson09_0.html</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Pick an offer<span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>div<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'0'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$0'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'1'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$1'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'2'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$2'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'3'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$3'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'4'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$4'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'5'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$5'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'6'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$6'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'7'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$7'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'8'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$8'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'9'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$9'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'10'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'$10'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;/</span>div<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>p <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"wait"</span><span style="color: #990000">&gt;</span>You offered $<span style="color: #990000">&lt;</span>span id<span style="color: #990000">=</span><span style="color: #FF0000">"offer"</span><span style="color: #990000">&gt;&lt;/</span>span<span style="color: #990000">&gt;...&lt;/</span>p<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>p <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"accept"</span><span style="color: #990000">&gt;</span>Player <span style="color: #993399">2</span> accepted your offer<span style="color: #990000">!&lt;/</span>p<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>p <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"reject"</span><span style="color: #990000">&gt;</span>Player <span style="color: #993399">2</span> rejected your offer<span style="color: #990000">!&lt;/</span>p<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>p <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"pay"</span><span style="color: #990000">&gt;</span>You earned $<span style="color: #990000">&lt;</span>span id<span style="color: #990000">=</span><span style="color: #FF0000">"payoff"</span><span style="color: #990000">&gt;&lt;/</span>span<span style="color: #990000">&gt;...&lt;/</span>p<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">lesson09_1.html</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>Waiting <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> player <span style="color: #993399">1</span><span style="color: #990000">...&lt;/</span>p<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>div <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"offer"</span><span style="color: #990000">&gt;</span>
  Player <span style="color: #993399">1</span> offered $<span style="color: #990000">&lt;</span>span id<span style="color: #990000">=</span><span style="color: #FF0000">"bid"</span><span style="color: #990000">&gt;&lt;/</span>span<span style="color: #990000">&gt;...</span>
  <span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'accept'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'accept'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
  <span style="color: #990000">&lt;</span>input <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"choice"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">'reject'</span> value<span style="color: #990000">=</span><span style="color: #FF0000">'reject'</span> type<span style="color: #990000">=</span><span style="color: #FF0000">'submit'</span> <span style="color: #990000">/&gt;</span>
<span style="color: #990000">&lt;/</span>div<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>p <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"pay"</span><span style="color: #990000">&gt;</span>You earned $<span style="color: #990000">&lt;</span>span id<span style="color: #990000">=</span><span style="color: #FF0000">"payoff"</span><span style="color: #990000">&gt;&lt;/</span>span<span style="color: #990000">&gt;...&lt;/</span>p<span style="color: #990000">&gt;</span></tt></pre></div></div>
</div>
<h2 id="_api_willow_willow">17. API: willow.willow</h2>
<div class="sectionbody">
<div class="paragraph"><div class="title">The <tt>selector</tt> argument on several API functions:</div><p>The <tt>selector</tt> argument can take any CSS selector. The CSS selector
mini-language is rather rich, but the most typical cases are things
like <tt>p</tt> (to get at all <tt>&lt;p&gt;</tt> elements), <tt>#a</tt>, (to get at the first
element with <tt>id="a"</tt>), and <tt>.a</tt> (to get at all elements with
<tt>class="a"</tt>). For more information, consult any book or web page on
CSS. Whenever <tt>selector</tt> is omitted, the selector "<tt>body</tt>" is implied,
which means you are referring to the entire body of the HTML
document. Aside from CSS selectors, jQuery extensions are also
allowed. The most useful is of the form <tt><em>selector</em>:eq(<em>n</em>)</tt>, which
selects the <em>n</em>-th element that matches <tt><em>selector</em></tt>.</p></div>
<div class="paragraph"><div class="title">The <tt>clients</tt> argument on several API functions:</div><p>By specifying an integer, or a sequence of integers, for
<tt>clients</tt>, you can operate directly on clients other than the one
associated by default with the current session thread.</p></div>
<div class="paragraph"><div class="title">The <tt>timestamp</tt> argument on several API functions:</div><p>Whenever <tt>timestamp=True</tt>, you are requesting a tuple to be posted
of the form <tt>{"tag":"timestamp","client":_n_,"time":_t_}</tt> that gives
you a millisecond timestamp of when the action was executed by the
client.</p></div>
<div class="paragraph"><div class="title">The <tt>delay</tt> argument on several API functions:</div><p>Whenever you specify the <tt>delay=<em>dt</em></tt> option, the execution of
that action is delayed by <tt><em>dt</em></tt> seconds (you can specify fractions of
seconds, too). This is done on the client side with millisecond
accuracy.</p></div>
<div class="paragraph"><p>If you have lots of closely spaced delayed events, at some point the
browser may start lagging; but in Google Chrome, I have gotten it up
to a <tt>set()</tt> event every milisecond with only a very slight lag.</p></div>
<h3 id="_tt_set_content_selector_clients_timestamp_delay_tt">17.1. <tt>set(content, [selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Set the content of the HTML element(s) referred to by <tt>selector</tt> on to
be <tt>content</tt>. Whenever <tt>content</tt> is a file descriptor that can be
read from, the contents of the file are automatically substituted.</p></div>
<h3 id="_tt_add_content_selector_clients_timestamp_delay_tt">17.2. <tt>add(content, [selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Add <tt>content</tt> to the content of the HTML element(s) referred to by
<tt>selector</tt>. Whenever <tt>content</tt> is a file descriptor that can be
read from, the contents of the file are automatically substituted.</p></div>
<h3 id="_tt_poke_attribute_value_selector_clients_timestamp_delay_tt">17.3. <tt>poke(attribute, value, [selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Change the value of attribute <tt>attribute</tt> to be <tt>value</tt> in HTML
element(s) referred to by <tt>selector</tt>.</p></div>
<h3 id="_tt_peek_selector_clients_tt">17.4. <tt>peek([selector], [clients])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Returns the value of the HTML <tt>&lt;input&gt;</tt> or <tt>&lt;textarea&gt;</tt> element(s)
referred to by <tt>selector</tt>.</p></div>
<h3 id="_tt_push_style_selector_clients_timestamp_delay_tt">17.5. <tt>push(style, [selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Add the CSS style <tt>style</tt> to the HTML element(s) referred to by
<tt>selector</tt>.</p></div>
<h3 id="_tt_pop_style_selector_clients_timestamp_delay_tt">17.6. <tt>pop(style, [selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Remove the CSS style <tt>style</tt> from HTML element(s) referred to by
<tt>selector</tt>.</p></div>
<h3 id="_tt_hide_selector_clients_timestamp_delay_tt">17.7. <tt>hide([selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Hide the HTML element(s) referred to by <tt>selector</tt>.</p></div>
<h3 id="_tt_show_selector_clients_timestamp_delay_tt">17.8. <tt>show([selector], [clients], [timestamp], [delay])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Show the HTML element(s) referred to by <tt>selector</tt>, if previously
hidden.</p></div>
<h3 id="_tt_put_dictionary_tt">17.9. <tt>put(dictionary)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Post the dictionary onto the communication board.</p></div>
<h3 id="_tt_take_queries_tt">17.10. <tt>take(*queries)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Block until a dictionary becomes present on the board that matches at
least one of the queries, then remove and return it. A dictionary
matches a query if it contains all the key-value pairs in the query
(plus, optionally, some others).</p></div>
<h3 id="_tt_grab_queries_tt">17.11. <tt>grab(*queries)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>If a dictionary is present on the board that matches at least one of
the queries remove and return it; otherwise return <tt>None</tt>. A
dictionary matches a query if it contains all the key-value pairs in
the query (plus, optionally, some others).</p></div>
<h3 id="_tt_run_session_port_tt">17.12. <tt>run(session, [port])</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>This starts the Willow web server on the specified port (or port
8000 if you leave the second argument out). The web server will
create a thread for each client that connects, and each thread will
run the <tt>session</tt> function, passing as an argument the client ID.</p></div>
<div class="paragraph"><p>Client IDs will be assigned sequentially, unless the URL is of the
form <tt>http://<em>whatever-host</em>/<em>n</em></tt>, where <tt><em>n</em></tt> is an integer, and
<tt><em>n</em></tt> is not taken yet, in which case the client ID will be <tt><em>n</em></tt>.</p></div>
<div class="paragraph"><p>If a client ID is requested that already exists, an attempt will be
made to replay all messages previously sent to that client. This
provides a limited amount of recovery from browser crashes. If the
browser crashed while a <tt>peek</tt> or <tt>timestamp</tt> request was pending,
this may not be sufficient. An attempt to fix that is in the works.</p></div>
<div class="paragraph"><p>The web server will search for requested files in the current
directory, among other places, so you can for instance include images
in your pages.</p></div>
<h3 id="_tt_background_fn_delay_tt">17.13. <tt>background(fn, delay)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Run the function <tt>fn</tt> in the background (as a separate thread), with
an initial <tt>delay</tt> specified in seconds. Fractions of seconds are
allowed.</p></div>
<h3 id="_tt_sleep_delay_tt">17.14. <tt>sleep(delay)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Wait for <tt>delay</tt> seconds. Fractions of seconds are allowed.</p></div>
<h3 id="_tt_log_x_y_8230_tt">17.15. <tt>log(x,y,&#8230;)</tt></h3><div style="clear:left"></div>
<div class="paragraph"><p>Write (x,y,&#8230;) to the log file as a record, with the number of
milliseconds since January 1, 1970 0:00 UTC prepended as the first
column. A new log file is created in the <tt>log</tt> folder whenever the
Willow library is loaded, and it bears a name based on the date and
time when it was created. For instance, if Willow was invoked at
15:32:42 on February 2 of the year 2010, the file would be called
<tt>log/2010-02-10-15-32-42.csv</tt>.  This particular date-and-time format
is used so that the files can be sorted by date/time. The log files
are in CSV format and can be opened with a text editor or a
spreadsheet program.</p></div>
<h3 id="_css_features">17.16. CSS features</h3><div style="clear:left"></div>
<div class="paragraph"><p>Some Willow features are accessed by means of CSS classes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>hidden</tt>
</dt>
<dd>
<p>
        Any element that has class <tt>hidden</tt> turned on will start out
        hidden. You can call <tt>show()</tt> on it to make it
        appear. Example: <tt>&lt;p&gt;At the moment, you can&lt;span
        class="hidden"&gt;not&lt;/span&gt; trade widgets.&lt;/p&gt;</tt>
</p>
</dd>
<dt class="hdlist1">
<tt>bait</tt>
</dt>
<dd>
<p>
        Any element that has class <tt>bait</tt> turned on will automatically
        get the additional class <tt>mouse</tt> turned on whenever the mouse
        pointer is positioned over that element. This can be used to
        create "hover" effects.
</p>
</dd>
</dl></div>
<h3 id="_mouse_clicks">17.17. Mouse clicks</h3><div style="clear:left"></div>
<div class="paragraph"><p>When a button with (whether <tt>&lt;input type="submit"&gt;</tt> or
<tt>&lt;button&gt;&lt;/button&gt;</tt>) or any element with <tt>class="clickable"</tt> is
clicked, a dictionary like is inserted into the board automatically
behind the scenes like so:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>{"tag":"click", "id":_id_, "client":_n_, "time":_t_, "value":_val_}</tt></pre>
</div></div>
<div class="paragraph"><p>where</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt><em>n</em></tt> is the number of the client that received the button click;
</p>
</li>
<li>
<p>
<tt><em>id</em></tt> is the <tt>id</tt> of the button;
</p>
</li>
<li>
<p>
<tt><em>t</em></tt> is the time in milliseconds since Jan 1, 1970 0:00 UTC,
   as measured by the client, when the value was checked;
</p>
</li>
<li>
<p>
<tt><em>val</em></tt> is the contents of the text box
</p>
</li>
</ul></div>
<h3 id="_key_presses">17.18. Key presses</h3><div style="clear:left"></div>
<div class="paragraph"><p>When the user presses a key, a dictionary like is inserted into the
board automatically behind the scenes like so:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>{"tag":"key", "client":_n_, "time":_t_, "value":_val_}</tt></pre>
</div></div>
<div class="paragraph"><p>where</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt><em>n</em></tt> is the number of the client that received the button click;
</p>
</li>
<li>
<p>
<tt><em>t</em></tt> is the time in milliseconds since Jan 1, 1970 0:00 UTC,
   as measured by the client, when the value was checked;
</p>
</li>
<li>
<p>
<tt><em>val</em></tt> is the key pressed
</p>
</li>
</ul></div>
</div>
<h2 id="_branch">18. Branch</h2>
<div class="sectionbody">
<div class="paragraph"><p>This is an extension library. It is liable to change, much faster than
Willow itself, and not be be as well documented and tested. But I
don&#8217;t want to withhold it either. This documentation is generated
directly from the <tt>branch.py</tt> source file.</p></div>
<h3 id="_assemble_session_clients_port_8000">18.1. assemble(session, clients=[], port=8000)</h3><div style="clear:left"></div>
<div class="paragraph"><p>This function is a replacement for run(). If clients is not
specified, it will display buttons on client 0 as clients 1, 2,
&#8230; log on, which show subsets of the clients that have logged on so
far. You can click one of these buttons at any time, and at that
point, the function session() will be run once for each client IN
THE SUBSET, with its client ID as the first number and the list of
all client IDs IN THE SUBSET as its second argument. Clients that
have connected but that are not in the subset will get a big X on
their screens. The second way of using assemble() is to specify an
explicit argument for clients=, some list of integers that indicates
which clients you want. Once those client numbers have logged on,
the session function is started once for every such client, and
again any clients not in the set get a big X.
=== Examples ===</p></div>
<div class="paragraph"><p>There is much additional useful code in the example_*.py files,
which illustrate various ways to use Willow.</p></div>
</div>
<h2 id="_appendix_a_digression_on_your_ip_address">19. Appendix: A digression on your IP address</h2>
<div class="sectionbody">
<div class="paragraph"><p>You need the IP address of your monitor computer in order for your
client computers to connect to it. It would be convenient if Willow
could display the right IP address for you to use, but unfortunately,
this is easier said than done, since a computer can have multiple IP
addresses at the same time: IP version 4 and IP version 6, on the
wireless network, on the ethernet network, on the "loopback" network,
and so on.</p></div>
<h3 id="_how_to_find_your_ip_address_on_linux">19.1. How to find your IP address on Linux</h3><div style="clear:left"></div>
<div class="paragraph"><p>On Linux on my computer, I use the <tt>ifconfig</tt> command at the command
line. When I enter</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ ifconfig</tt></pre>
</div></div>
<div class="paragraph"><p>the computer responds</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ ifconfig
eth1      Link encap:Ethernet  HWaddr 00:23:ae:1e:9e:ac
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
          Interrupt:17

eth2      Link encap:Ethernet  HWaddr 00:24:2b:c6:a4:76
          inet addr:10.143.91.80  Bcast:10.143.91.255  Mask:255.255.254.0
          inet6 addr: fe80::224:2bff:fec6:a476/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:10076 errors:0 dropped:0 overruns:0 frame:7868
          TX packets:10906 errors:20 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:1571308 (1.5 MB)  TX bytes:1341157 (1.3 MB)
          Interrupt:17 Base address:0xc000

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:85540 errors:0 dropped:0 overruns:0 frame:0
          TX packets:85540 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:41237280 (41.2 MB)  TX bytes:41237280 (41.2 MB)
$</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">In this and many other software manuals, <tt>$</tt> is used to indicate
the Linux/UNIX prompt. On your computer, it may be different. <tt>%</tt> is a
popular choice, too, for example.</td>
</tr></table>
</div>
<div class="paragraph"><p>There is much information here, but we only need a little. First,
notice that this computer has three network interfaces, called <tt>eth1</tt>,
<tt>eth2</tt> and <tt>lo</tt>. <tt>lo</tt> is the loopback device; it does not correspond
to any actual hardware, but it is rather a contraption that the
operating system uses so that you can make connections to your own
machine at address <tt>127.0.0.1</tt> even when the network is down. The
other two network devices are actual network cards that are in the
computer; as it happens, <tt>eth1</tt> is a wired Ethernet network, and
<tt>eth2</tt> is a wireless 802.11g network. According to the information
above, the computer has IP address 10.143.91.80 on <tt>eth2</tt>, and it has
no IP address on <tt>eth1</tt>, which makes sense, because the wired
connection was not plugged when I executed the command. In the output
above you can also see IP v6 addresses (labeled <tt>inet6 addr</tt>), but
those are not commonly used.</p></div>
<h3 id="_how_to_find_your_ip_address_on_windows">19.2. How to find your IP address on Windows</h3><div style="clear:left"></div>
<div class="paragraph"><p>Press <em>WINDOWS</em>+R (where <em>WINDOWS</em> is the "Windows Key", the one with
the flag) to pull up a "Run Program" dialog, then enter <tt>cmd</tt> to get a
command prompt window. Now enter <tt>ipconfig /a</tt>. This should give you
all the information you need.</p></div>
</div>
<h2 id="_appendix_kiosk_mode_browsing">20. Appendix: Kiosk mode browsing</h2>
<div class="sectionbody">
<div class="paragraph"><p>In order to prevent subjects from fiddling around with the web browser
used to display a user interface to them, you can use a "kiosk mode"
web browser. While several web browsers have kiosk modes, I have found
that Google Chrome is the most convenient. On Linux, you simply use
the command line <tt>google-chrome --kiosk</tt> instead of just
<tt>google-chrome</tt>, and you get a full-screen browser without any
extraneous bits of user interface that subjects might accidentally
click on.</p></div>
</div>
<h2 id="_appendix_internals">21. Appendix: Internals</h2>
<div class="sectionbody">
<div class="verseblock">
<div class="verseblock-content">Je n&#8217;ai fait celle-ci plus longue que parce que je n&#8217;ai pas eu le
loisir de la faire plus courte.</div>
<div class="verseblock-attribution">
<em>Lettres Provinciales</em><br />
&#8212; Blaise Pascal
</div></div>
<div class="paragraph"><p>The first thing that should strike you when looking at these files is
that there&#8217;s not very much there. This is on purpose, and took a lot
of work. It is my experience that the number of bugs per 100 lines of
code is roughly constant, and that the best way of limiting the number
of bugs is to limit the amount of code. (In the extreme case, of
course that means that the only way to have no bugs is to write no
code. This is not as vacuous an observation as it seems: it pays to
think twice before deciding to turn something into a computer program
in the first place.)</p></div>
<div class="imageblock">
<div class="content">
<img src="architecture.png" alt="architecture.png" />
</div>
</div>
<div class="listingblock">
<div class="title">willow.py</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Willow, a Python framework for experimental economics. Copyright (c)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># 2009, George Mason University. All rights reserved. Redistribution</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># allowed under certain conditions; see file COPYING.txt</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># WILLOW #############################################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># This file is a library that you can use to write a server. You use</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># such a server in combination with a client. The client is always a</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># web browser displaying willow.html and running willow.js. None of</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># this client-server business, however, is germane to the way you</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># ought to think about writing a Willow application, though: you can</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># write your application as though you were using a regular old GUI</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># toolkit and there wasn't a client/server architecture or a network</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># in the first place.</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The comments in this file are meant for people who have some</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># experience with distributed systems and want to hack Willow</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># itself. If you merely want to USE the Willow library to construct</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># your own applications, read the manual instead.</span></span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> json<span style="color: #990000">,</span> BaseHTTPServer<span style="color: #990000">,</span> time<span style="color: #990000">,</span> Queue<span style="color: #990000">,</span> mimetypes<span style="color: #990000">,</span> SocketServer
<span style="font-weight: bold"><span style="color: #000080">import</span></span> threading<span style="color: #990000">,</span> sys<span style="color: #990000">,</span> csv<span style="color: #990000">,</span> os<span style="color: #990000">,</span> os<span style="color: #990000">.</span>path<span style="color: #990000">,</span> copy<span style="color: #990000">,</span> re<span style="color: #990000">,</span> stat


<span style="font-style: italic"><span style="color: #9A1900"># LOGGING ############################################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># This section provides the code that produces the output files, which</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># go in the log/ directory.</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The file names for output files are constructed so as to work on all</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># platforms. This means we use os.path.join to insert the right path</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># separator, and we do not the ':' character, which has a special</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># meaning on Windows (as in "C:\"). All output is unbuffered</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (bufsize=0) and synchronized on a single mutex. This code SHOULD be</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># unicode-safe (important if we want to use it in, say, China), but I</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># haven't tested that very much.</span></span>

_log_fn <span style="color: #990000">=</span> os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"log"</span><span style="color: #990000">,</span>time<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">strftime</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%Y-%m-%d-%H-%M-%S"</span><span style="color: #990000">))</span>
_log_csv <span style="color: #990000">=</span> csv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writer</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>_log_fn <span style="color: #990000">+</span> <span style="color: #FF0000">".csv"</span><span style="color: #990000">,</span><span style="color: #FF0000">"w"</span><span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">))</span>
_log_txt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>_log_fn <span style="color: #990000">+</span> <span style="color: #FF0000">".txt"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"w"</span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
_log_lock <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Lock</span></span><span style="color: #990000">()</span>

tbl <span style="color: #990000">=</span> <span style="color: #990000">[]</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(*</span>msg<span style="color: #990000">):</span>
  with _log_lock<span style="color: #990000">:</span>
    _log_csv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writerow</span></span><span style="color: #990000">([</span><span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span><span style="color: #993399">1000</span><span style="color: #990000">*</span>time<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">time</span></span><span style="color: #990000">())]</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">list</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">))</span>
    tbl<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"log"</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">unicode</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">tuple</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)))</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span>tag<span style="color: #990000">,</span> <span style="color: #990000">*</span>objs<span style="color: #990000">):</span>
  with _log_lock<span style="color: #990000">:</span>
    msg <span style="color: #990000">=</span> <span style="color: #FF0000">"\n"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">([</span> <span style="color: #990000">(</span><span style="color: #FF0000">"%s"</span> <span style="color: #990000">%</span> d<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> d <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> objs <span style="color: #990000">])</span>
    out <span style="color: #990000">=</span> <span style="color: #FF0000">""</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> line <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">(</span>msg <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">splitlines</span></span><span style="color: #990000">():</span>
      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> i <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="font-weight: bold"><span style="color: #000000">range</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>line<span style="color: #990000">),</span><span style="color: #993399">70</span><span style="color: #990000">):</span>
        out <span style="color: #990000">+=</span> <span style="color: #FF0000">"        "</span> <span style="color: #990000">+</span> line<span style="color: #990000">[</span>i<span style="color: #990000">:</span>i<span style="color: #990000">+</span><span style="color: #993399">70</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">"\n"</span>
    s <span style="color: #990000">=</span> <span style="color: #FF0000">"%-4s %2d %s"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>tag<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">_me</span></span><span style="color: #990000">(),</span> out<span style="color: #990000">[</span><span style="color: #993399">8</span><span style="color: #990000">:])</span>
    lines <span style="color: #990000">=</span> s<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">splitlines</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>lines<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">10</span><span style="color: #990000">:</span> lines <span style="color: #990000">=</span> lines<span style="color: #990000">[:</span><span style="color: #993399">3</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #990000">[</span><span style="color: #FF0000">"..."</span><span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> line <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> lines<span style="color: #990000">:</span> sys<span style="color: #990000">.</span>stdout<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>line <span style="color: #990000">+</span> <span style="color: #FF0000">"\n"</span><span style="color: #990000">)</span>
    _log_txt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%s\t%d\t%r\n"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>tag<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">_me</span></span><span style="color: #990000">(),</span> msg<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_trace_action</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">):</span>
  tag <span style="color: #990000">=</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"action"</span><span style="color: #990000">]</span>
  msg <span style="color: #990000">=</span> <span style="color: #FF0000">"(%s)"</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"selector"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"timestamp"</span><span style="color: #990000">,</span> False<span style="color: #990000">):</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">" ...timestamp..."</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"delay"</span><span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">" ...%s..."</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"delay"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"css_class"</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">""</span><span style="color: #990000">:</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">" %s"</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"css_class"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"attribute"</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">""</span><span style="color: #990000">:</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">" %s="</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"attribute"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"value"</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">""</span><span style="color: #990000">:</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">"%s"</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"content"</span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">""</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">str</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">]))&gt;</span><span style="color: #993399">50</span><span style="color: #990000">:</span>
      msg <span style="color: #990000">+=</span> <span style="color: #FF0000">"\n"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
      msg <span style="color: #990000">+=</span> <span style="color: #FF0000">" "</span>
    msg <span style="color: #990000">+=</span> <span style="color: #FF0000">"%s"</span> <span style="color: #990000">%</span> obj<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span>tag<span style="color: #990000">,</span> msg<span style="color: #990000">)</span>


<span style="font-style: italic"><span style="color: #9A1900"># TUPLE SPACE ########################################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The tuple space is for communication between session threads, and</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># for asynchronous messages from the clients to the session</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># threads. (Messages from the session threads to the clients go</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># through a system of queues instead, which we will meet in the next</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># session.) It allows you to write your program without shared state</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># between threads, and thus without your having to worry about</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># race conditions.</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Conceptually, the tuple space is a multiset of dictionaries, but</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Python doesn't have multisets, so we use a dictionary of</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># dictionaries in which the keys are not really used for much of</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># anything (they are simply sequentially assigned integers). All</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># access to the tuple space is synchronized on a condition variable. A</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># put() operation is a simple matter of inserting a value into the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># dictionary and waking up any threads that are blocking on take(). A</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># deep copy is made of the inserted object to prevent a user from</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># accidentally sharing data structures between threads by way of the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># tuple space; the whole point of the tuple space is to facilitate a</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># shared-nothing archictecture in which the user need not be concerned</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># with mutual exclusion! There are both blocking (take()) and</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># nonblocking (grab()) functions for retrieving (and deleting)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># dictionaries from the space, and both of those invoke a simple</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># linear search. To facilitate future extensions along the lines of</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the Metaweb Query Language (both faster-than-linear search if that</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># turns out necessary and also more elaborate query constructs), I</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># restrict keys in the dictionaries and in queries to be only strings.</span></span>

_board_space   <span style="color: #990000">=</span> <span style="color: #990000">{}</span>
_board_counter <span style="color: #990000">=</span> <span style="color: #993399">0</span>
_board_cv      <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Condition</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>item<span style="color: #990000">):</span>
  with _board_cv<span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #0000FF">global</span></span> _board_counter
    <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>item<span style="color: #990000">)</span> <span style="color: #990000">==</span> dict
    <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>key<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="color: #990000">[</span>unicode<span style="color: #990000">,</span> str<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> key <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> item<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">keys</span></span><span style="color: #990000">()</span> <span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"put"</span><span style="color: #990000">,</span> item<span style="color: #990000">)</span>
    _board_counter <span style="color: #990000">+=</span> <span style="color: #993399">1</span>
    _board_space<span style="color: #990000">[</span>_board_counter<span style="color: #990000">]</span> <span style="color: #990000">=</span> copy<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">deepcopy</span></span><span style="color: #990000">(</span>item<span style="color: #990000">)</span>
    _board_cv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">notifyAll</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_find</span></span><span style="color: #990000">(</span>pop<span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> number<span style="color: #990000">,</span> item <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> _board_space<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">iteritems</span></span><span style="color: #990000">():</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> pattern <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> patterns<span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>key<span style="color: #990000">)</span> <span style="color: #990000">==</span> str <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> key <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> pattern<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">keys</span></span><span style="color: #990000">()</span> <span style="color: #990000">])</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span> k <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> item <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> item<span style="color: #990000">[</span>k<span style="color: #990000">]</span> <span style="color: #990000">==</span> v <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> k<span style="color: #990000">,</span>v <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> pattern<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">iteritems</span></span><span style="color: #990000">()]):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pop<span style="color: #990000">:</span> _board_space<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">(</span>number<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> item
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> None

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">(*</span>patterns<span style="color: #990000">):</span>
  with _board_cv<span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"take"</span><span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
      item <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_find</span></span><span style="color: #990000">(</span>True<span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> item <span style="color: #990000">!=</span> None<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
      _board_cv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">wait</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"took"</span><span style="color: #990000">,</span> item<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> item

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">view</span></span><span style="color: #990000">(*</span>patterns<span style="color: #990000">):</span>
  with _board_cv<span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"view"</span><span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
      item <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_find</span></span><span style="color: #990000">(</span>False<span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> item <span style="color: #990000">!=</span> None<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
      _board_cv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">wait</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"veow"</span><span style="color: #990000">,</span> item<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> item

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">grab</span></span><span style="color: #990000">(*</span>patterns<span style="color: #990000">):</span>
  with _board_cv<span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"grab"</span><span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
    item <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_find</span></span><span style="color: #990000">(</span>True<span style="color: #990000">,</span> <span style="color: #990000">*</span>patterns<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"grub"</span><span style="color: #990000">,</span> item<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> item


<span style="font-style: italic"><span style="color: #9A1900"># THREAD POOL EXTENSION TO THE PYTHON TCP SERVER #####################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># In order to get decent performance on Windows, we must improve a bit</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># upon the standard Python TCP server. In particular, we replace</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># SocketServer.ThreadingMixIn with a homebrew class.</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># If you want to use the original, you can try this instead:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># class WillowPool(SocketServer.ThreadingMixIn): pass</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> WillowPool<span style="color: #990000">:</span>
  <span style="font-style: italic"><span style="color: #9A1900"># By default, we create "non-daemon" threads.</span></span>
  daemon_threads <span style="color: #990000">=</span> False

  <span style="font-style: italic"><span style="color: #9A1900"># The pool is a queue of available worker threads</span></span>
  pool <span style="color: #990000">=</span> Queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Queue</span></span><span style="color: #990000">()</span>

  <span style="font-style: italic"><span style="color: #9A1900"># A new worker thread creates a mailbox (i.e. length-1 queue) in</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># which to receive assignments. It then goes to sleep, but it wakes</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># up whenever it gets an assignment. When it gets an assignment, it</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># does the server thing, and then adds itself to the pool to</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># indicate that it is available again.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Worker</span></span><span style="color: #990000">(</span>threading<span style="color: #990000">.</span>Thread<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> server<span style="color: #990000">):</span>
      threading<span style="color: #990000">.</span>Thread<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">)</span>
      self<span style="color: #990000">.</span>server <span style="color: #990000">=</span> server
      self<span style="color: #990000">.</span>mailbox <span style="color: #990000">=</span> Queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Queue</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
        <span style="color: #990000">(</span>request<span style="color: #990000">,</span> address<span style="color: #990000">)</span> <span style="color: #990000">=</span> self<span style="color: #990000">.</span>mailbox<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">()</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
          self<span style="color: #990000">.</span>server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">finish_request</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> address<span style="color: #990000">)</span>
          self<span style="color: #990000">.</span>server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close_request</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">except</span></span><span style="color: #990000">:</span>
          self<span style="color: #990000">.</span>server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">handle_error</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> address<span style="color: #990000">)</span>
          self<span style="color: #990000">.</span>server<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close_request</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>server<span style="color: #990000">.</span>pool<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>self<span style="color: #990000">)</span>

  <span style="font-style: italic"><span style="color: #9A1900"># When a request comes in, we try to get a worker from the pool. If</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># there are none, we make a new one. Then we tell the worker to</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># work.</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">process_request</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> request<span style="color: #990000">,</span> address<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
      worker <span style="color: #990000">=</span> self<span style="color: #990000">.</span>pool<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get_nowait</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> Queue<span style="color: #990000">.</span>Empty<span style="color: #990000">:</span>
      worker <span style="color: #990000">=</span> self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Worker</span></span><span style="color: #990000">(</span>self<span style="color: #990000">)</span>
      worker<span style="color: #990000">.</span>daemon <span style="color: #990000">=</span> self<span style="color: #990000">.</span>daemon_threads
      worker<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">()</span>
    worker<span style="color: #990000">.</span>mailbox<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">((</span>request<span style="color: #990000">,</span> address<span style="color: #990000">))</span>



<span style="font-style: italic"><span style="color: #9A1900"># WEB SERVER #########################################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The Willow web server is built on Python's BaseHTTPServer. It uses a</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># new thread for each request, which is slow on Windows. A thread pool</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># would be useful improvement. GET requests are served from the file</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># system, but POST requests are special and assumed to come from</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># willow.js. They come in three flavors: a newly connected client</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># POSTs to /new first, requesting a client ID. On this occasion, a</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># queue is created and inserted into the _clients dictionary</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># (synchronized on a condition variable) keyed by the new client ID,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># and a session thread is started. The queue is for communication</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># between the web server threads and the session thread. Once the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># client ID is determined it is sent to the client, which can now make</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># to other kinds of POST requests. The first is to URL /put, and this</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># simply lets the client put something on the tuple space. (The client</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># objects are JSON data structures, which map directly onto Python</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># data structures and no further processing is required.) The second</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># type of POST request from the client is a request for commands, and</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># these commands the web server gets from the queue corresponding to</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the client, where they are put by the session thread corresponding</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># to the client. If multiple commands are on the queue, they are all</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># sent to the client at once. The commands are assumed to be</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># dictionaries and because they are sent in JSON, so conversion from</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Python comes (again) nearly free.</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Client<span style="color: #990000">:</span>
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>queue <span style="color: #990000">=</span> Queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Queue</span></span><span style="color: #990000">()</span>
    self<span style="color: #990000">.</span>trace <span style="color: #990000">=</span> <span style="color: #990000">[]</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> msg<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>trace<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">replay</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    cancellation <span style="color: #990000">=</span> Queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Queue</span></span><span style="color: #990000">()</span>
    self<span style="color: #990000">.</span>queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>cancellation<span style="color: #990000">)</span>
    cancellation<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> msg <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> self<span style="color: #990000">.</span>trace<span style="color: #990000">:</span>
      self<span style="color: #990000">.</span>queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)</span>

_clients <span style="color: #990000">=</span> <span style="color: #990000">{}</span>
_clients_cv <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Condition</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>session<span style="color: #990000">,</span> port<span style="color: #990000">=</span><span style="color: #993399">8000</span><span style="color: #990000">):</span>
  webroot <span style="color: #990000">=</span> os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dirname</span></span><span style="color: #990000">(</span>__file__<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> os<span style="color: #990000">.</span>curdir
  <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Handler</span></span><span style="color: #990000">(</span>BaseHTTPServer<span style="color: #990000">.</span>BaseHTTPRequestHandler<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">log_message</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> fmt<span style="color: #990000">,</span> <span style="color: #990000">*</span>arg<span style="color: #990000">):</span>      <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">do_GET</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
      fns <span style="color: #990000">=</span> <span style="color: #990000">[</span> os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span>os<span style="color: #990000">.</span>curdir<span style="color: #990000">,</span> self<span style="color: #990000">.</span>path<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">:]),</span>
              os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span>os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dirname</span></span><span style="color: #990000">(</span>__file__<span style="color: #990000">),</span> self<span style="color: #990000">.</span>path<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">:]),</span>
              os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span>os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dirname</span></span><span style="color: #990000">(</span>__file__<span style="color: #990000">),</span> <span style="color: #FF0000">"willow.html"</span><span style="color: #990000">)</span> <span style="color: #990000">]</span>
      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> fn <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> fns<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isfile</span></span><span style="color: #990000">(</span>fn<span style="color: #990000">):</span>
          mime <span style="color: #990000">=</span> mimetypes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">guess_type</span></span><span style="color: #990000">(</span>fn<span style="color: #990000">)</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>mime<span style="color: #990000">)</span> <span style="color: #990000">==</span> tuple<span style="color: #990000">:</span> mime <span style="color: #990000">=</span> mime<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> re<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">search</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".js$"</span><span style="color: #990000">,</span> fn<span style="color: #990000">):</span>  mime <span style="color: #990000">=</span> <span style="color: #FF0000">"text/javascript"</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> re<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">search</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".css$"</span><span style="color: #990000">,</span> fn<span style="color: #990000">):</span> mime <span style="color: #990000">=</span> <span style="color: #FF0000">"text/css"</span>
          self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_response</span></span><span style="color: #990000">(</span><span style="color: #993399">200</span><span style="color: #990000">)</span>
          self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_header</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Content-type"</span><span style="color: #990000">,</span> mime<span style="color: #990000">)</span>
          self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">end_headers</span></span><span style="color: #990000">()</span>
          self<span style="color: #990000">.</span>wfile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>fn<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">())</span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">do_POST</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
      self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_response</span></span><span style="color: #990000">(</span><span style="color: #993399">200</span><span style="color: #990000">)</span>
      self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_header</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Content-type"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"application/json"</span><span style="color: #990000">)</span>
      self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">end_headers</span></span><span style="color: #990000">()</span>
      request_sz <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>headers<span style="color: #990000">[</span><span style="color: #FF0000">"Content-length"</span><span style="color: #990000">])</span>
      request_str <span style="color: #990000">=</span> self<span style="color: #990000">.</span>rfile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>request_sz<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span>
      request_obj <span style="color: #990000">=</span> json<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loads</span></span><span style="color: #990000">(</span>request_str<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>path <span style="color: #990000">==</span> <span style="color: #FF0000">"/new"</span><span style="color: #990000">:</span>
        with _clients_cv<span style="color: #990000">:</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> request_obj <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
            client <span style="color: #990000">=</span> <span style="color: #993399">0</span>
            <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> client <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> _clients<span style="color: #990000">:</span>
              client <span style="color: #990000">+=</span> <span style="color: #993399">1</span>
          <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
            client <span style="color: #990000">=</span> request_obj
          self<span style="color: #990000">.</span>wfile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>client<span style="color: #990000">)</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> client <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> _clients<span style="color: #990000">:</span>
            _clients<span style="color: #990000">[</span>client<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Client</span></span><span style="color: #990000">()</span>
            thread <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Thread</span></span><span style="color: #990000">(</span>target<span style="color: #990000">=</span>session<span style="color: #990000">,</span>
                                      args<span style="color: #990000">=(</span>client<span style="color: #990000">,),</span>
                                      name<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #000000">str</span></span><span style="color: #990000">(</span>client<span style="color: #990000">))</span>
            thread<span style="color: #990000">.</span>daemon <span style="color: #990000">=</span> True
            thread<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">()</span>
          <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #000000">_iam</span></span><span style="color: #990000">(</span>client<span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"bork"</span><span style="color: #990000">,</span> <span style="color: #FF0000">" *** CLIENT %s RESTARTED *** "</span> <span style="color: #990000">%</span> client<span style="color: #990000">)</span>
            _clients<span style="color: #990000">[</span>client<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">replay</span></span><span style="color: #990000">()</span>

      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>path <span style="color: #990000">==</span> <span style="color: #FF0000">"/put"</span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #000000">_iam</span></span><span style="color: #990000">(</span>request_obj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"client"</span><span style="color: #990000">,-</span><span style="color: #993399">1</span><span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>request_obj<span style="color: #990000">)</span>

      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>path <span style="color: #990000">==</span> <span style="color: #FF0000">"/do"</span><span style="color: #990000">:</span>
        client <span style="color: #990000">=</span> request_obj
        <span style="font-weight: bold"><span style="color: #000000">_iam</span></span><span style="color: #990000">(</span>client<span style="color: #990000">)</span>
        queue <span style="color: #990000">=</span> _clients<span style="color: #990000">[</span>client<span style="color: #990000">].</span>queue
        actions <span style="color: #990000">=</span> <span style="color: #990000">[]</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> actions <span style="color: #990000">==</span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">():</span>
              action <span style="color: #990000">=</span> queue<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">()</span>
              <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>action<span style="color: #990000">,</span>Queue<span style="color: #990000">.</span>Queue<span style="color: #990000">):</span>
                action<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">)</span>
                <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> Exception
              <span style="font-weight: bold"><span style="color: #000000">_trace_action</span></span><span style="color: #990000">(</span>action<span style="color: #990000">)</span>
              actions<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>action<span style="color: #990000">)</span>
            self<span style="color: #990000">.</span>wfile<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>json<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dumps</span></span><span style="color: #990000">(</span>actions<span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> Exception<span style="color: #990000">:</span>
          <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Server</span></span><span style="color: #990000">(</span>WillowPool<span style="color: #990000">,</span> BaseHTTPServer<span style="color: #990000">.</span>HTTPServer<span style="color: #990000">):</span>
    daemon_threads <span style="color: #990000">=</span> True
    allow_reuse_address <span style="color: #990000">=</span> True

  <span style="font-weight: bold"><span style="color: #000000">_iam</span></span><span style="color: #990000">(-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">_trace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"run"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Willow is running on port %s"</span> <span style="color: #990000">%</span> port<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">Server</span></span><span style="color: #990000">((</span><span style="color: #FF0000">''</span><span style="color: #990000">,</span> port<span style="color: #990000">),</span> Handler<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">serve_forever</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_me</span></span><span style="color: #990000">():</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">current_thread</span></span><span style="color: #990000">().</span>name<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_iam</span></span><span style="color: #990000">(</span>n<span style="color: #990000">):</span>
  threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">current_thread</span></span><span style="color: #990000">().</span>name <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">str</span></span><span style="color: #990000">(</span>n<span style="color: #990000">)</span>



<span style="font-style: italic"><span style="color: #9A1900"># IO #################################################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># This is where the bulk of the Willow API is: functions that do</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># nothing but send a command to the client, which then processes the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># command in Javascript somehow. Documentation is in the manual. The</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># one interesting point is that each session thread has one integer's</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># worth of thread-local storage: the client ID of its corresponding</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># client. That way, the user can call add(foo) rather than having to</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># type add(foo,me) all the time.</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">(</span>object<span style="color: #990000">,</span> clients<span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> clients <span style="color: #990000">==</span> None<span style="color: #990000">:</span> clients <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_me</span></span><span style="color: #990000">()</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>clients<span style="color: #990000">)</span> <span style="color: #990000">==</span> int<span style="color: #990000">:</span> clients <span style="color: #990000">=</span> <span style="color: #990000">[</span>clients<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">"content"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> object <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>object<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">])</span> <span style="color: #990000">==</span> file<span style="color: #990000">:</span>
    object<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> object<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">()</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">"content"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> object<span style="color: #990000">:</span> object<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">str</span></span><span style="color: #990000">(</span>object<span style="color: #990000">[</span><span style="color: #FF0000">"content"</span><span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">"value"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> object<span style="color: #990000">:</span> object<span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">str</span></span><span style="color: #990000">(</span>object<span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> client <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> clients<span style="color: #990000">:</span>
    _clients<span style="color: #990000">[</span>client<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span>object<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>content<span style="color: #990000">,</span> selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span> timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'add'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'content'</span><span style="color: #990000">:</span> content<span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">let</span></span><span style="color: #990000">(</span>content<span style="color: #990000">,</span> selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span> timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'let'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'content'</span><span style="color: #990000">:</span> content<span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">poke</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">,</span> value<span style="color: #990000">,</span> selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span>
         timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'poke'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'attribute'</span><span style="color: #990000">:</span> attribute<span style="color: #990000">,</span> <span style="color: #FF0000">'value'</span><span style="color: #990000">:</span> value<span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">hide</span></span><span style="color: #990000">(</span>selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span> timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'hide'</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span>selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span> timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'show'</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>css_class<span style="color: #990000">,</span> selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span>
         timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'push'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'css_class'</span><span style="color: #990000">:</span> css_class<span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">(</span>css_class<span style="color: #990000">,</span> selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">,</span>
        timestamp<span style="color: #990000">=</span>False<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'pop'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'css_class'</span><span style="color: #990000">:</span> css_class<span style="color: #990000">,</span>
            <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> timestamp<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> delay <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>

_ticket_lock <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Lock</span></span><span style="color: #990000">()</span>
_ticket <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">peek</span></span><span style="color: #990000">(</span>selector<span style="color: #990000">=</span><span style="color: #FF0000">"body"</span><span style="color: #990000">,</span> clients<span style="color: #990000">=</span>None<span style="color: #990000">):</span>
  with _ticket_lock<span style="color: #990000">:</span>
    _ticket<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">+=</span> <span style="color: #993399">1</span>
    ticket <span style="color: #990000">=</span> _ticket<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #000000">_action</span></span><span style="color: #990000">({</span> <span style="color: #FF0000">'action'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'peek'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'selector'</span><span style="color: #990000">:</span> selector<span style="color: #990000">,</span>
            <span style="color: #FF0000">'ticket'</span><span style="color: #990000">:</span> ticket<span style="color: #990000">,</span>
            <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span> False<span style="color: #990000">,</span> <span style="color: #FF0000">"delay"</span><span style="color: #990000">:</span> <span style="color: #993399">0</span> <span style="color: #990000">},</span> clients<span style="color: #990000">)</span>
  msg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take</span></span><span style="color: #990000">({</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span><span style="color: #FF0000">"peek"</span><span style="color: #990000">,</span><span style="color: #FF0000">"ticket"</span><span style="color: #990000">:</span>ticket<span style="color: #990000">})</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> msg<span style="color: #990000">[</span><span style="color: #FF0000">'value'</span><span style="color: #990000">]</span>



<span style="font-style: italic"><span style="color: #9A1900"># THREADING ##########################################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The background() function allows the user to start a new</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># thread. This adjusts the thread-local stored client ID so that you</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># can still call add() etc from inside the new thread and they will</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># know which client to operate on. It also takes an optional delay, so</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># you can use this to schedule events. Otherwise, it's just your basic</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># forking operation.</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">background</span></span><span style="color: #990000">(</span>function<span style="color: #990000">,</span> delay<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">):</span>
  name <span style="color: #990000">=</span> threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">current_thread</span></span><span style="color: #990000">().</span>name
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">thunk</span></span><span style="color: #990000">():</span>
    threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">current_thread</span></span><span style="color: #990000">().</span>name <span style="color: #990000">=</span> name
    <span style="font-weight: bold"><span style="color: #000000">function</span></span><span style="color: #990000">()</span>
  threading<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Timer</span></span><span style="color: #990000">(</span>delay<span style="color: #990000">,</span> thunk<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">sleep</span></span><span style="color: #990000">(</span>delay<span style="color: #990000">):</span>
  time<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sleep</span></span><span style="color: #990000">(</span>delay<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">willow.html</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- Willow, a Python framework for experimental economics. Copyright</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> (c) 2009, George Mason University. All rights</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> reserved. Redistribution allowed under certain conditions; see file</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> COPYING.txt.  --&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Willow<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"jquery.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"json.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"willow.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/css"</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"willow.css"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span>
</tt></pre></div></div>
<div class="listingblock">
<div class="title">willow.css</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Willow, a Python framework for experimental economics. Copyright (c)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * 2009, George Mason University. All rights reserved. Redistribution</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * allowed under certain conditions; see file COPYING.txt</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>

<span style="color: #993399">.hidden</span> <span style="color: #FF0000">{</span>
    <span style="color: #0000FF">display:</span> <span style="font-style: italic"><span style="color: #009900">none</span></span>;
<span style="color: #FF0000">}</span>

</tt></pre></div></div>
<div class="listingblock">
<div class="title">willow.js</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *  Willow, a Python framework for experimental economics. Copyright</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * (c) 2009, George Mason University. All rights reserved. Redistribution</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * allowed under certain conditions; see file COPYING.txt.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>

$<span style="color: #990000">(</span>document<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">ready</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   * The preferred client ID is the URL if that is an integer, or else</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   * 0. We will not know the actual ID until after we haved logged in.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> url <span style="color: #990000">=</span> window<span style="color: #990000">.</span>location<span style="color: #990000">.</span>pathname<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">slice</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> preferred_client <span style="color: #990000">=</span> url <span style="color: #990000">?</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">round</span></span><span style="color: #990000">(</span>url <span style="color: #990000">-</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">""</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"-1"</span><span style="color: #990000">;</span>
  <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   * Now log in.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
  $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"new"</span><span style="color: #990000">,</span> preferred_client<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>client<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

    <span style="font-style: italic"><span style="color: #9A1900">/* At this point we are logged in, and we know the actual client</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * number. First, we will define a few helper functions, and then</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * we will start listening for server requests.*/</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * This function makes a call back to the server to post a</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * dictionary on the board. It is used both for requested (tag=peek)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * and automatic (tag=click, tag=key) dictionaries. It decorates the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * dictionary with two additional entries that indicate (i) client</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * number and (ii) a time stamp; these are used in all dictionaries</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * posted by the client, so we might as well just code them once.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * Keep in mind that client is a string and we want an integer</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * here, so subtract 0.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      obj<span style="color: #990000">.</span>client <span style="color: #990000">=</span> client <span style="color: #990000">-</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
      obj<span style="color: #990000">.</span>time <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Date</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">getTime</span></span><span style="color: #990000">();</span>
      $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"put"</span><span style="color: #990000">,</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">stringify</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * Catch keypresses no matter what is in focus and post them to</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * the board. We can do this once and for all, because all keypresses</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * accrue to the document object, and there is only one such</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * object. (Other event handlers are adjusted every time the page</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * content changes.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    $<span style="color: #990000">(</span>document<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">keypress</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>e<span style="color: #990000">.</span>which<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"key"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fromCharCode</span></span><span style="color: #990000">(</span>e<span style="color: #990000">.</span>which<span style="color: #990000">)</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * This function is to be called on newly inserted or modified</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * HTML elements. It makes sure that the correct event handlers are</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * bound. This works better than trying to use the jQuery system of</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * live events.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>elt<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * Key presses that happen when a text field is in focus</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * should be processed the normal way and should not result in</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * events being reported to the server.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> text_fields <span style="color: #990000">=</span> elt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"input:text,textarea"</span><span style="color: #990000">);</span>
      text_fields<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">keypress</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        e<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">stopPropagation</span></span><span style="color: #990000">();</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * When somebody clicks a button, or a "clickable" element, we</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * catch the click and report it.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> buttons <span style="color: #990000">=</span> elt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">":submit,:button,.clickable"</span><span style="color: #990000">);</span>
      buttons<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">);</span>
      buttons<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>  <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> e<span style="color: #990000">.</span>currentTarget<span style="color: #990000">.</span>id<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * When an element is marked with class "bait", we want to</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * turn on class "mouse" whenever the mouse is over it. (This</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * is for implementing "hover" effects.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mousetraps <span style="color: #990000">=</span> elt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".bait"</span><span style="color: #990000">);</span>
      mousetraps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mouseenter"</span><span style="color: #990000">);</span>
      mousetraps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mouseleave"</span><span style="color: #990000">);</span>
      mousetraps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mouseenter mouseleave"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span>e<span style="color: #990000">.</span>target<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">closest</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".bait"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggleClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mouse"</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * This function processes a list of commands received from the</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * server, and then immediately asks for more commands.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">action</span></span><span style="color: #990000">(</span>cmds<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * Process each command.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> cmds<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> cmd <span style="color: #990000">=</span> cmds<span style="color: #990000">[</span>i<span style="color: #990000">];</span>
          <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">thunk</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>action<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * Most of the commands correspond directly to jQuery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * methods; we call decorate() on the result to make sure that</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * new/modified HTML elements have the right event handlers</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * bound.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             */</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"add"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>content<span style="color: #990000">));</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"let"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>content<span style="color: #990000">));</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"poke"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>attribute<span style="color: #990000">,</span> cmd<span style="color: #990000">.</span>value<span style="color: #990000">));</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"push"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>css_class<span style="color: #990000">));</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"pop"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #000000">decorate</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeClass</span></span><span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>css_class<span style="color: #990000">));</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"hide"</span><span style="color: #990000">:</span>
              $<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">hide</span></span><span style="color: #990000">();</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"show"</span><span style="color: #990000">:</span>
              $<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>

            <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * The "peek" command is a request for the contents of</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * some input element to be posted to the tuple space.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * jQuery has a method .val() that will get the content</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             *  of all sorts input elements; quite convenient!</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             */</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"peek"</span><span style="color: #990000">:</span>
              <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> elt <span style="color: #990000">=</span> $<span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>selector<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>elt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">()</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> val <span style="color: #990000">=</span> elt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">eq</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #990000">||</span> <span style="color: #FF0000">""</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> val <span style="color: #990000">=</span> <span style="color: #FF0000">""</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
              <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"peek"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"ticket"</span><span style="color: #990000">:</span> cmd<span style="color: #990000">.</span>ticket<span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> val<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
              <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="color: #FF0000">}</span>

            <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * All commands can come with an optional request for a</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * timestamp to be posted; the put() function puts on the actual</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             * timestamp.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             */</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>timestamp<span style="color: #990000">)</span>
              <span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> <span style="color: #FF0000">"tag"</span><span style="color: #990000">:</span><span style="color: #FF0000">"timestamp"</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
          <span style="color: #FF0000">}</span>
          <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * If cmd.delay &gt; 0, the request is for the command to be</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * scheduled rather than executed immediately; that's easy</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * enough to handle using window.setTimeout.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           */</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cmd<span style="color: #990000">.</span>delay <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            window<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setTimeout</span></span><span style="color: #990000">(</span>thunk<span style="color: #990000">,</span> <span style="color: #993399">1000</span> <span style="color: #990000">*</span> cmd<span style="color: #990000">.</span>delay<span style="color: #990000">);</span>
          <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #000000">thunk</span></span><span style="color: #990000">();</span>
          <span style="color: #FF0000">}</span>

          <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * The use of an anonymous function that immediately gets</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * called may seem strange, but it's a workaround for Javascript's</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           * dyslexical scoping (pun intended).</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           */</span></span>
        <span style="color: #FF0000">}</span><span style="color: #990000">)();</span>
      <span style="color: #FF0000">}</span>

      <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * Request more commands. (At your service!) Note how the loop</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * works: we the action() function registers itself as a</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * callback. This is NOT recursion and will NOT overflow the stack.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * This here trick, BTW, is known under various highfalutin names such</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       * as "Comet" and "reverse AJAX".</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
      $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"do"</span><span style="color: #990000">,</span> client<span style="color: #990000">,</span> action<span style="color: #990000">,</span> <span style="color: #FF0000">"json"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * Request some commands to set the ball rolling.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    <span style="font-weight: bold"><span style="color: #000000">action</span></span><span style="color: #990000">([]);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
</tt></pre></div></div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2010-09-15 11:36:16 PDT
</div>
</div>
</body>
</html>
